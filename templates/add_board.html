{% extends "base.html" %}

{% block title %}Add Company - DailyScraper{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1>Add New Company</h1>
    <a href="/boards" class="btn btn-secondary">Back to Companies</a>
</div>

<div class="card" style="max-width: 600px;">
    <form method="POST">
        <div class="form-group">
            <label class="form-label" for="name">Company Name</label>
            <input type="text" id="name" name="name" class="form-input" required
                   placeholder="e.g., Acme Corp">
        </div>

        <div class="form-group">
            <label class="form-label" for="url">Careers Page URL</label>
            <div style="display: flex; gap: 0.5rem;">
                <input type="url" id="url" name="url" class="form-input" required
                       placeholder="https://..." style="flex: 1;">
                <button type="button" id="autoDetectBtn" class="btn btn-primary" onclick="autoDetect()" style="white-space: nowrap;">
                    Auto-detect
                </button>
            </div>
            <div id="autoDetectStatus" style="margin-top: 0.5rem; font-size: 0.9rem;"></div>
        </div>

        <div class="form-group">
            <label class="form-label" for="type">Job Board Type</label>
            <select id="type" name="type" class="form-select" onchange="toggleSelectors()">
                <option value="generic">Generic (Custom Selectors)</option>
                <option value="greenhouse">Greenhouse</option>
                <option value="lever">Lever</option>
                <option value="ashby">Ashby</option>
                <option value="nextjs">Next.js</option>
                <option value="api">API</option>
            </select>
        </div>

        <div id="selectors" class="selectors-group">
            <h3 style="margin-bottom: 1rem;">CSS Selectors</h3>
            <p style="color: #86868b; font-size: 0.9rem; margin-bottom: 1rem;">
                Inspect the website to find the CSS selectors for each field.
            </p>

            <div class="form-group">
                <label class="form-label" for="selector_job_container">Job Container Selector *</label>
                <input type="text" id="selector_job_container" name="selector_job_container" class="form-input"
                       placeholder="div.job">
            </div>

            <div class="form-group">
                <label class="form-label" for="selector_title">Title Selector *</label>
                <input type="text" id="selector_title" name="selector_title" class="form-input"
                       placeholder="h2">
            </div>

            <div class="form-group">
                <label class="form-label" for="selector_link">Link Selector *</label>
                <input type="text" id="selector_link" name="selector_link" class="form-input"
                       placeholder="a">
            </div>

            <div class="form-group">
                <label class="form-label" for="selector_location">Location Selector (optional)</label>
                <input type="text" id="selector_location" name="selector_location" class="form-input"
                       placeholder=".location">
            </div>

            <div class="form-group">
                <label class="form-label" for="selector_description">Description Selector (optional)</label>
                <input type="text" id="selector_description" name="selector_description" class="form-input"
                       placeholder=".description">
            </div>

            <div class="form-group">
                <label class="form-label" for="selector_date_posted">Date Posted Selector (optional)</label>
                <input type="text" id="selector_date_posted" name="selector_date_posted" class="form-input"
                       placeholder=".date">
            </div>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
            <button type="submit" class="btn btn-primary">Add Company</button>
            <a href="/boards" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleSelectors() {
    const type = document.getElementById('type').value;
    const selectors = document.getElementById('selectors');

    if (type === 'generic') {
        selectors.classList.add('active');
    } else {
        selectors.classList.remove('active');
    }
}

async function autoDetect() {
    const urlInput = document.getElementById('url');
    const url = urlInput.value.trim();
    const statusDiv = document.getElementById('autoDetectStatus');
    const button = document.getElementById('autoDetectBtn');

    if (!url) {
        statusDiv.innerHTML = '<span style="color: #ff3b30;">Please enter a URL first</span>';
        return;
    }

    // Show loading state
    button.disabled = true;
    button.textContent = 'Detecting...';
    statusDiv.innerHTML = '<span style="color: #86868b;">Analyzing page...</span>';

    try {
        const response = await fetch('/api/auto-detect', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ url: url })
        });

        const result = await response.json();

        if (result.error) {
            statusDiv.innerHTML = `<span style="color: #ff3b30;">Error: ${result.error}</span>`;
        } else if (result.success) {
            // Set the type to generic
            document.getElementById('type').value = 'generic';
            toggleSelectors();

            // Populate the selector fields
            if (result.job_container) {
                document.getElementById('selector_job_container').value = result.job_container;
            }
            if (result.title) {
                document.getElementById('selector_title').value = result.title;
            }
            if (result.link) {
                document.getElementById('selector_link').value = result.link;
            }
            if (result.location) {
                document.getElementById('selector_location').value = result.location;
            }
            if (result.description) {
                document.getElementById('selector_description').value = result.description;
            }
            if (result.date_posted) {
                document.getElementById('selector_date_posted').value = result.date_posted;
            }

            statusDiv.innerHTML = `<span style="color: #34c759;">âœ“ Found ${result.found_jobs} job listings! Selectors auto-filled.</span>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<span style="color: #ff3b30;">Error: ${error.message}</span>`;
    } finally {
        button.disabled = false;
        button.textContent = 'Auto-detect';
    }
}

// Show selectors by default since generic is selected
toggleSelectors();
</script>
{% endblock %}
