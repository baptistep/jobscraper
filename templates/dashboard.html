{% extends "base.html" %}

{% block title %}Dashboard - DailyScraper{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1 style="margin: 0;">Dashboard</h1>
    <button id="scrapeBtn" class="btn btn-primary" onclick="triggerScrape()">
        <span id="scrapeBtnText">Run Scraper Now</span>
    </button>
</div>

<div id="scrapeStatus" style="margin-bottom: 1rem;"></div>

<div class="stats">
    <div class="stat-card">
        <div class="stat-number">{{ total_jobs }}</div>
        <div class="stat-label">Total Jobs</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ new_jobs_count }}</div>
        <div class="stat-label">New Jobs (24h)</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ active_boards }}</div>
        <div class="stat-label">Active Companies</div>
    </div>
</div>

{% for source, jobs in grouped_jobs.items() %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">
            {{ source }}
            <span style="color: #86868b; font-weight: normal; font-size: 0.9rem;">({{ jobs|length }} jobs)</span>
        </h2>
        <a href="/jobs/{{ source }}" class="btn btn-secondary btn-small">View All</a>
    </div>

    <div>
        {% for job in jobs[:5] %}
        <div class="job-item {% if job.is_new %}new{% endif %}">
            <div class="job-info">
                <div class="job-title">
                    {{ job.title }}
                    {% if job.is_new %}
                    <span class="badge badge-new">NEW</span>
                    {% endif %}
                </div>
                <div class="job-meta">
                    {% if job.location %}{{ job.location }} • {% endif %}
                    {% if job.department %}{{ job.department }} • {% endif %}
                    {% if job.date_posted %}Posted: {{ job.date_posted }}{% endif %}
                </div>
            </div>
            <a href="{{ job.url }}" target="_blank" class="btn btn-secondary btn-small">View Job</a>
        </div>
        {% endfor %}

        {% if jobs|length > 5 %}
        <div style="padding: 1rem; text-align: center; color: #86868b;">
            + {{ jobs|length - 5 }} more jobs
        </div>
        {% endif %}
    </div>
</div>
{% endfor %}

{% if not grouped_jobs %}
<div class="card">
    <div style="text-align: center; padding: 2rem; color: #86868b;">
        <p>No jobs found. Add some companies to track to get started!</p>
        <a href="/boards/add" class="btn btn-primary" style="margin-top: 1rem;">Add Company</a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
let statusCheckInterval = null;

async function triggerScrape() {
    const button = document.getElementById('scrapeBtn');
    const buttonText = document.getElementById('scrapeBtnText');
    const statusDiv = document.getElementById('scrapeStatus');

    // Disable button
    button.disabled = true;
    buttonText.textContent = 'Starting scraper...';

    try {
        const response = await fetch('/api/scrape', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const result = await response.json();

        if (response.ok) {
            statusDiv.innerHTML = '<div class="alert alert-success">Scraper is running. This may take a few minutes...</div>';

            // Start polling for status
            statusCheckInterval = setInterval(checkScrapeStatus, 2000);
        } else {
            statusDiv.innerHTML = `<div class="alert alert-error">${result.error || 'Failed to start scraper'}</div>`;
            button.disabled = false;
            buttonText.textContent = 'Run Scraper Now';
        }
    } catch (error) {
        statusDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
        button.disabled = false;
        buttonText.textContent = 'Run Scraper Now';
    }
}

async function checkScrapeStatus() {
    const button = document.getElementById('scrapeBtn');
    const buttonText = document.getElementById('scrapeBtnText');
    const statusDiv = document.getElementById('scrapeStatus');

    try {
        const response = await fetch('/api/scrape/status');
        const status = await response.json();

        if (!status.running) {
            // Scraping finished
            clearInterval(statusCheckInterval);
            statusCheckInterval = null;

            button.disabled = false;
            buttonText.textContent = 'Run Scraper Now';

            if (status.error) {
                statusDiv.innerHTML = `<div class="alert alert-error">Scraper failed: ${status.error}</div>`;
            } else if (status.last_result) {
                const result = status.last_result;
                if (result.success) {
                    statusDiv.innerHTML = `<div class="alert alert-success">✓ Scraping completed! Found ${result.new_jobs} new job(s). Total jobs: ${result.total_jobs}. <a href="#" onclick="location.reload()">Refresh page</a> to see updates.</div>`;
                } else {
                    statusDiv.innerHTML = '<div class="alert alert-error">Scraper completed with errors. Check logs for details.</div>';
                }
            }
        } else {
            // Still running - update button text
            buttonText.textContent = 'Scraping...';
        }
    } catch (error) {
        console.error('Error checking scrape status:', error);
    }
}

// Check if scraper is already running on page load
window.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch('/api/scrape/status');
        const status = await response.json();

        if (status.running) {
            const button = document.getElementById('scrapeBtn');
            const buttonText = document.getElementById('scrapeBtnText');

            button.disabled = true;
            buttonText.textContent = 'Scraping...';

            document.getElementById('scrapeStatus').innerHTML = '<div class="alert alert-success">Scraper is currently running...</div>';

            // Start polling
            statusCheckInterval = setInterval(checkScrapeStatus, 2000);
        }
    } catch (error) {
        console.error('Error checking initial scrape status:', error);
    }
});
</script>
{% endblock %}
